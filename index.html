<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danbooru Tag Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --accent-color: #4f46e5;
        --accent-color-hover: #4338ca;
        --processed-tag-bg: rgba(79, 70, 229, 0.2);
        --processed-tag-text: rgba(199, 210, 254, 1);
        --processed-tag-border: #4f46e5;
        --selected-tag-border: #f59e0b;
        --glass-bg: rgba(31, 41, 55, 0.8);
        --glass-border: rgba(75, 85, 99, 0.3);
      }
      
      /* Theme variations */
      .theme-blue { --accent-color: #2563eb; --accent-color-hover: #1d4ed8; --processed-tag-bg: rgba(37, 99, 235, 0.2); --processed-tag-text: rgba(191, 219, 254, 1); --processed-tag-border: #2563eb; }
      .theme-teal { --accent-color: #0d9488; --accent-color-hover: #0f766e; --processed-tag-bg: rgba(13, 148, 136, 0.2); --processed-tag-text: rgba(153, 246, 228, 1); --processed-tag-border: #0d9488; }
      .theme-crimson { --accent-color: #dc2626; --accent-color-hover: #b91c1c; --processed-tag-bg: rgba(220, 38, 38, 0.2); --processed-tag-text: rgba(254, 202, 202, 1); --processed-tag-border: #dc2626; }
      .theme-emerald { --accent-color: #10b981; --accent-color-hover: #059669; --processed-tag-bg: rgba(16, 185, 129, 0.2); --processed-tag-text: rgba(167, 243, 208, 1); --processed-tag-border: #10b981; }
      .theme-purple { --accent-color: #8b5cf6; --accent-color-hover: #7c3aed; --processed-tag-bg: rgba(139, 92, 246, 0.2); --processed-tag-text: rgba(221, 214, 254, 1); --processed-tag-border: #8b5cf6; }
      .theme-amber { --accent-color: #f59e0b; --accent-color-hover: #d97706; --processed-tag-bg: rgba(245, 158, 11, 0.2); --processed-tag-text: rgba(254, 243, 199, 1); --processed-tag-border: #f59e0b; }
      .theme-rose { --accent-color: #f43f5e; --accent-color-hover: #e11d48; --processed-tag-bg: rgba(244, 63, 94, 0.2); --processed-tag-text: rgba(254, 205, 211, 1); --processed-tag-border: #f43f5e; }
      .theme-cyan { --accent-color: #06b6d4; --accent-color-hover: #0891b2; --processed-tag-bg: rgba(6, 182, 212, 0.2); --processed-tag-text: rgba(165, 243, 252, 1); --processed-tag-border: #06b6d4; }
      
      body { 
        font-family: 'Inter', sans-serif; 
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #f8fafc; 
        min-height: 100vh;
      }
      
      .glass-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      
      .input-base { 
        border: 1px solid #4b5563; 
        background: rgba(55, 65, 81, 0.8);
        backdrop-filter: blur(8px);
        color: #f9fafb; 
        border-radius: 0.75rem; 
        padding: 0.75rem 1rem; 
        transition: all 0.2s ease-in-out; 
        font-size: 0.9rem;
      }
      .input-base:focus { 
        outline: none;
        border-color: var(--accent-color); 
        box-shadow: 0 0 0 3px rgba(var(--accent-color), 0.1), 0 0 20px rgba(var(--accent-color), 0.2);
        background: rgba(55, 65, 81, 0.95);
      }
      
      .btn-primary {
        background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-color-hover) 100%);
        color: white;
        border: none;
        border-radius: 0.75rem;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 4px 12px rgba(var(--accent-color), 0.3);
      }
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(var(--accent-color), 0.4);
      }
      .btn-primary:active {
        transform: translateY(0);
      }
      
      .tag-base { 
        font-size: 0.875rem; 
        font-weight: 500; 
        padding: 0.5rem 1rem; 
        border-radius: 2rem; 
        border: 2px solid;
        display: inline-flex; 
        align-items: center; 
        gap: 0.5rem; 
        cursor: grab; 
        background: var(--processed-tag-bg);
        color: var(--processed-tag-text); 
        border-color: var(--processed-tag-border); 
        transition: all 0.2s ease-in-out;
        backdrop-filter: blur(8px);
        position: relative;
        overflow: hidden;
      }
      .tag-base::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transition: left 0.5s;
      }
      .tag-base:hover::before {
        left: 100%;
      }
      .tag-base:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(var(--processed-tag-border), 0.3);
      }
      .tag-base.selected { 
        border-color: var(--selected-tag-border); 
        box-shadow: 0 0 0 2px var(--selected-tag-border), 0 8px 25px rgba(var(--selected-tag-border), 0.4);
        transform: translateY(-2px);
      }
      .tag-base:active { cursor: grabbing; }
      
      .tag-group-title { 
        font-size: 0.8rem; 
        text-transform: uppercase; 
        letter-spacing: 0.1em; 
        color: #cbd5e1; 
        margin-bottom: 1rem; 
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .tag-group-title::after {
        content: '';
        flex: 1;
        height: 1px;
        background: linear-gradient(90deg, var(--accent-color), transparent);
      }
      
      .tag-group-container { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 0.75rem; 
        min-height: 60px; 
        padding: 1rem; 
        background: rgba(0,0,0,0.2);
        border-radius: 1rem;
        border: 1px dashed rgba(var(--accent-color), 0.3);
        transition: all 0.2s ease-in-out;
      }
      .tag-group-container:hover {
        background: rgba(0,0,0,0.3);
        border-color: rgba(var(--accent-color), 0.5);
      }
      
      #autocomplete-box { 
        position: absolute; 
        z-index: 50; 
        background: rgba(31, 41, 55, 0.95);
        backdrop-filter: blur(12px);
        border: 1px solid #4b5563; 
        border-radius: 0.75rem; 
        max-height: 200px; 
        overflow-y: auto; 
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
      }
      .autocomplete-item { 
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
        border-bottom: 1px solid rgba(75, 85, 99, 0.3);
      }
      .autocomplete-item:hover, .autocomplete-item.selected { 
        background: var(--accent-color);
        color: white;
      }
      .autocomplete-item:last-child {
        border-bottom: none;
      }
      
      .theme-button { 
        width: 2rem; 
        height: 2rem; 
        border-radius: 50%; 
        border: 3px solid transparent; 
        cursor: pointer; 
        transition: all 0.2s ease-in-out;
        position: relative;
        overflow: hidden;
      }
      .theme-button:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      }
      .theme-button.active { 
        border-color: white;
        box-shadow: 0 0 0 2px rgba(255,255,255,0.5), 0 8px 25px rgba(0,0,0,0.4);
        transform: scale(1.1);
      }
      
      .floating-panel {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 40;
        display: flex;
        gap: 0.75rem;
        align-items: center;
        padding: 1rem;
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      
      .quick-action-btn {
        padding: 0.5rem;
        background: rgba(55, 65, 81, 0.6);
        border: 1px solid rgba(75, 85, 99, 0.5);
        border-radius: 0.5rem;
        color: #e2e8f0;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }
      .quick-action-btn:hover {
        background: var(--accent-color);
        color: white;
        transform: translateY(-1px);
      }
      
      .stats-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }
      .stat-item {
        text-align: center;
        padding: 1rem;
        background: rgba(0,0,0,0.3);
        border-radius: 1rem;
        border: 1px solid rgba(var(--accent-color), 0.3);
      }
      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent-color);
      }
      .stat-label {
        font-size: 0.75rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      
      .advanced-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }
      
      .control-group {
        padding: 1rem;
        background: rgba(0,0,0,0.2);
        border-radius: 1rem;
        border: 1px solid rgba(var(--accent-color), 0.2);
      }
      
      .control-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #cbd5e1;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      
      /* Improved animations */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .fade-in-up {
        animation: fadeInUp 0.5s ease-out;
      }
      
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.2);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--accent-color);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--accent-color-hover);
      }
      
      /* Responsive improvements */
      @media (max-width: 768px) {
        .floating-panel {
          position: static;
          margin-bottom: 2rem;
          justify-content: center;
        }
        .stats-panel {
          grid-template-columns: repeat(2, 1fr);
        }
        .advanced-controls {
          grid-template-columns: 1fr;
        }
      }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">
    <!-- Floating theme panel -->
            <div class="floating-panel">
        <span class="text-sm font-medium text-gray-300">Theme:</span>
        <button class="theme-button" style="background: linear-gradient(135deg, #4f46e5, #6366f1);" data-theme="theme-indigo" title="Indigo"></button>
        <button class="theme-button" style="background: linear-gradient(135deg, #2563eb, #3b82f6);" data-theme="theme-blue" title="Blue"></button>
        <button class="theme-button" style="background: linear-gradient(135deg, #0d9488, #14b8a6);" data-theme="theme-teal" title="Teal"></button>
        <button class="theme-button" style="background: linear-gradient(135deg, #dc2626, #ef4444);" data-theme="theme-crimson" title="Crimson"></button>
        <button class="theme-button" style="background: linear-gradient(135deg, #10b981, #34d399);" data-theme="theme-emerald" title="Emerald"></button>
        <button class="theme-button" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa);" data-theme="theme-purple" title="Purple"></button>
        <button class="theme-button" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);" data-theme="theme-amber" title="Amber"></button>
        <button class="theme-button" style="background: linear-gradient(135deg, #f43f5e, #fb7185);" data-theme="theme-rose" title="Rose"></button>
        <button class="theme-button" style="background: linear-gradient(135deg, #06b6d4, #22d3ee);" data-theme="theme-cyan" title="Cyan"></button>
        
        <div class="w-px h-6 bg-gray-600 mx-2"></div>
        
        <button class="quick-action-btn" title="GitHub Token Settings" onclick="showTokenSettings()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                <path d="M9 12l2 2 4-4"></path>
            </svg>
        </button>
        
        <button class="quick-action-btn" title="Import/Export Settings" onclick="toggleSettingsPanel()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 15l0 6"></path>
                <path d="M8 21l8 0"></path>
                <path d="M8.56 17.198l0 0c-.345 -.865 -.819 -1.698 -1.319 -2.48c-.5 -.782 -1.028 -1.517 -1.56 -2.198c-.532 -.681 -1.068 -1.316 -1.56 -1.895"></path>
                <path d="M15.44 17.198l0 0c.345 -.865 .819 -1.698 1.319 -2.48c.5 -.782 1.028 -1.517 1.56 -2.198c.532 -.681 1.068 -1.316 1.56 -1.895"></path>
                <circle cx="12" cy="6" r="3"></circle>
            </svg>
        </button>
        
        <button class="quick-action-btn" title="Clear All" onclick="clearAll()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6l-12 12"></path>
                <path d="M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <div class="glass-panel max-w-7xl mx-auto p-6 md:p-8 fade-in-up">
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-white via-gray-200 to-gray-400 bg-clip-text text-transparent mb-4">
                Danbooru Tag Helper
            </h1>
            <p class="text-gray-400 text-lg">Advanced AI Art Prompt Management</p>
        </div>

        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="stat-item">
                <div class="stat-value" id="tagCount">0</div>
                <div class="stat-label">Active Tags</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="maxTagCount">75</div>
                <div class="stat-label">Max Tags</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="categoryCount">0</div>
                <div class="stat-label">Categories</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="historyCount">0</div>
                <div class="stat-label">History</div>
            </div>
        </div>

        <!-- Advanced Controls -->
        <div class="advanced-controls">
            <div class="control-group">
                <div class="control-label">AI Suggestions</div>
                <div class="flex items-center gap-2 mb-3">
                    <input type="number" id="suggestionCountInput" value="15" min="5" max="50" 
                           class="input-base text-sm flex-1" placeholder="Count">
                    <button id="suggest-btn" class="btn-primary">Generate</button>
                </div>
                <div class="flex flex-wrap gap-2 text-sm">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="rating-safe" class="rounded" checked>
                        <span>Safe</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="rating-general" class="rounded" checked>
                        <span>General</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="rating-questionable" class="rounded">
                        <span>Questionable</span>
                    </label>
                </div>
            </div>

            <div class="control-group">
                <div class="control-label">Processing Options</div>
                <div class="space-y-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input id="deduplicateToggle" type="checkbox" class="rounded" checked>
                        <span class="text-sm">Deduplicate Tags</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input id="underscoreToggle" type="checkbox" class="rounded" checked>
                        <span class="text-sm">Use Underscores</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input id="enableWeightingToggle" type="checkbox" class="rounded">
                        <span class="text-sm">Enable Weighting</span>
                    </label>
                </div>
            </div>

            <div class="control-group">
                <div class="control-label">Sorting & Limits</div>
                <div class="space-y-3">
                    <select id="sortSelect" class="input-base text-sm w-full">
                        <option value="danbooru" selected>Sort: Danbooru</option>
                        <option value="manual">Sort: Manual</option>
                        <option value="none">Sort: None</option>
                        <option value="az">Sort: A-Z</option>
                        <option value="za">Sort: Z-A</option>
                    </select>
                    <input type="number" id="maxTagsInput" value="75" min="1" max="500" 
                           class="input-base text-sm w-full" placeholder="Max Tags">
                </div>
            </div>

            <div class="control-group">
                <div class="control-label">Quick Actions</div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="randomizeTags()" class="quick-action-btn text-center py-2">
                        <div class="text-xs">Randomize</div>
                    </button>
                    <button onclick="optimizeOrder()" class="quick-action-btn text-center py-2">
                        <div class="text-xs">Optimize</div>
                    </button>
                    <button onclick="exportTags()" class="quick-action-btn text-center py-2">
                        <div class="text-xs">Export</div>
                    </button>
                    <button onclick="importTags()" class="quick-action-btn text-center py-2">
                        <div class="text-xs">Import</div>
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Input Section -->
            <div class="lg:col-span-4 space-y-6">
                <div>
                    <label for="tagInput" class="control-label mb-3 block">Main Tags</label>
                    <div class="relative">
                        <textarea id="tagInput" rows="6" class="input-base w-full resize-none" 
                                  placeholder="1girl, solo, masterpiece, black background..."></textarea>
                        <div id="autocomplete-box" class="w-full hidden"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="control-label mb-2 block">Prepend</label>
                        <input type="text" id="triggerInput" class="input-base w-full" 
                               placeholder="best quality...">
                    </div>
                    <div>
                        <label class="control-label mb-2 block">Append</label>
                        <input type="text" id="appendInput" class="input-base w-full" 
                               placeholder="style_name...">
                    </div>
                </div>

                <div>
                    <label for="swapsInput" class="control-label mb-2 block">Aliases / Swaps</label>
                    <textarea id="swapsInput" rows="3" class="input-base w-full" 
                              placeholder="girl -> 1girl, boobs -> large_breasts"></textarea>
                </div>

                <div>
                    <label for="implicationsInput" class="control-label mb-2 block">Implications</label>
                    <textarea id="implicationsInput" rows="3" class="input-base w-full" 
                              placeholder="1girl => backlighting"></textarea>
                </div>

                <div>
                    <label for="blacklistInput" class="control-label mb-2 block">Blacklist</label>
                    <textarea id="blacklistInput" rows="2" class="input-base w-full" 
                              placeholder="bad_anatomy, blurry, text"></textarea>
                </div>
            </div>

            <!-- Main Output Section -->
            <div class="lg:col-span-5">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-200 mb-4 flex items-center gap-3">
                        Processed Tags
                        <span class="text-sm font-normal px-3 py-1 rounded-full" 
                              style="background: var(--processed-tag-bg); color: var(--processed-tag-text);">
                            <span id="processedTagCount">0</span>/<span id="processedMaxTagCount">75</span>
                        </span>
                    </h2>
                </div>

                <div id="tagOutput" class="glass-panel p-6 min-h-[500px] space-y-6 mb-6">
                    <div class="text-gray-500 italic text-center py-12">
                        Start typing or paste tags above to begin...
                    </div>
                </div>

                <button id="copyButton" class="btn-primary w-full py-4 text-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                    Copy All Tags
                </button>
                <p id="copyMessage" class="text-sm text-green-400 mt-3 h-5 text-center"></p>
            </div>

            <!-- History Section -->
            <div class="lg:col-span-3">
                <h3 class="text-lg font-semibold text-gray-200 mb-4">History</h3>
                <div id="history-container" class="space-y-3">
                    <p class="text-sm text-gray-500 italic">No history yet.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Token Settings Panel -->
    <div id="tokenPanel" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="hideTokenSettings()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 glass-panel p-6 w-full max-w-lg">
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                GitHub Token Settings
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="control-label mb-2 block">Personal Access Token</label>
                    <input type="password" id="githubTokenInput" class="input-base w-full" 
                           placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                    <p class="text-xs text-gray-400 mt-1">
                        Token needs 'repo' or 'public_repo' scope for tag corrections
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="rememberToken" class="rounded">
                    <label for="rememberToken" class="text-sm text-gray-300">Remember token (stored locally)</label>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="saveToken()" class="btn-primary">Save Token</button>
                    <button onclick="testToken()" class="quick-action-btn py-2">Test Connection</button>
                </div>
                <div class="border-t border-gray-600 pt-4">
                    <h4 class="font-medium mb-2">Token Status</h4>
                    <div id="tokenStatus" class="text-sm text-gray-400">
                        No token configured
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Panel (hidden by default) -->
    <div id="settingsPanel" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="toggleSettingsPanel()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 glass-panel p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Import/Export Settings</h3>
            <div class="space-y-4">
                <button onclick="exportSettings()" class="btn-primary w-full">Export Settings</button>
                <input type="file" id="importFile" accept=".json" class="hidden" onchange="importSettings(event)">
                <button onclick="document.getElementById('importFile').click()" class="btn-primary w-full">Import Settings</button>
                <button onclick="resetToDefaults()" class="quick-action-btn w-full py-2">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <script>
    // Your existing JavaScript would go here, with these additional functions:
    
    function toggleSettingsPanel() {
        const panel = document.getElementById('settingsPanel');
        panel.classList.toggle('hidden');
    }
    
    function clearAll() {
        if (confirm('Clear all tags and settings?')) {
            document.getElementById('tagInput').value = '';
            document.getElementById('triggerInput').value = '';
            document.getElementById('appendInput').value = '';
            document.getElementById('swapsInput').value = '';
            document.getElementById('implicationsInput').value = '';
            document.getElementById('blacklistInput').value = '';
            // Trigger processing update
            processAll();
        }
    }
    
    function randomizeTags() {
        // Implementation to randomize tag order within categories
        console.log('Randomizing tags...');
    }
    
    function optimizeOrder() {
        // Implementation to optimize tag order for better AI results
        console.log('Optimizing tag order...');
    }
    
    function exportTags() {
        const tagElements = document.querySelectorAll('#tagOutput .tag-base');
        const tags = Array.from(tagElements).map(el => el.dataset.weightedTag || el.textContent.trim());
        const data = {
            tags: tags,
            settings: {
                prepend: document.getElementById('triggerInput').value,
                append: document.getElementById('appendInput').value,
                maxTags: document.getElementById('maxTagsInput').value,
                sorting: document.getElementById('sortSelect').value
            },
            timestamp: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `danbooru-tags-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }
    
    function importTags() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,.txt';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(content);
                        if (data.tags) {
                            document.getElementById('tagInput').value = data.tags.join(', ');
                        }
                        if (data.settings) {
                            if (data.settings.prepend) document.getElementById('triggerInput').value = data.settings.prepend;
                            if (data.settings.append) document.getElementById('appendInput').value = data.settings.append;
                            if (data.settings.maxTags) document.getElementById('maxTagsInput').value = data.settings.maxTags;
                            if (data.settings.sorting) document.getElementById('sortSelect').value = data.settings.sorting;
                        }
                    } else {
                        // Plain text file
                        document.getElementById('tagInput').value = content.trim();
                    }
                    processAll();
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }
    
    function exportSettings() {
        const settings = {
            theme: document.body.className.match(/theme-\w+/)?.[0] || 'theme-indigo',
            prepend: document.getElementById('triggerInput').value,
            append: document.getElementById('appendInput').value,
            swaps: document.getElementById('swapsInput').value,
            implications: document.getElementById('implicationsInput').value,
            blacklist: document.getElementById('blacklistInput').value,
            maxTags: document.getElementById('maxTagsInput').value,
            sorting: document.getElementById('sortSelect').value,
            deduplicate: document.getElementById('deduplicateToggle').checked,
            underscores: document.getElementById('underscoreToggle').checked,
            weighting: document.getElementById('enableWeightingToggle').checked,
            ratings: {
                safe: document.getElementById('rating-safe').checked,
                general: document.getElementById('rating-general').checked,
                questionable: document.getElementById('rating-questionable').checked
            }
        };
        
        const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `danbooru-helper-settings-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }
    
    function importSettings(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const settings = JSON.parse(e.target.result);
                
                if (settings.theme) applyTheme(settings.theme);
                if (settings.prepend !== undefined) document.getElementById('triggerInput').value = settings.prepend;
                if (settings.append !== undefined) document.getElementById('appendInput').value = settings.append;
                if (settings.swaps !== undefined) document.getElementById('swapsInput').value = settings.swaps;
                if (settings.implications !== undefined) document.getElementById('implicationsInput').value = settings.implications;
                if (settings.blacklist !== undefined) document.getElementById('blacklistInput').value = settings.blacklist;
                if (settings.maxTags !== undefined) document.getElementById('maxTagsInput').value = settings.maxTags;
                if (settings.sorting !== undefined) document.getElementById('sortSelect').value = settings.sorting;
                if (settings.deduplicate !== undefined) document.getElementById('deduplicateToggle').checked = settings.deduplicate;
                if (settings.underscores !== undefined) document.getElementById('underscoreToggle').checked = settings.underscores;
                if (settings.weighting !== undefined) document.getElementById('enableWeightingToggle').checked = settings.weighting;
                if (settings.ratings) {
                    if (settings.ratings.safe !== undefined) document.getElementById('rating-safe').checked = settings.ratings.safe;
                    if (settings.ratings.general !== undefined) document.getElementById('rating-general').checked = settings.ratings.general;
                    if (settings.ratings.questionable !== undefined) document.getElementById('rating-questionable').checked = settings.ratings.questionable;
                }
                
                toggleSettingsPanel();
                processAll();
                
                document.getElementById('copyMessage').textContent = 'Settings imported successfully!';
                setTimeout(() => document.getElementById('copyMessage').textContent = '', 3000);
            } catch (error) {
                alert('Error importing settings: ' + error.message);
            }
        };
        reader.readAsText(file);
    }
    
    function resetToDefaults() {
        if (confirm('Reset all settings to defaults?')) {
            // Reset all form values to defaults
            document.getElementById('tagInput').value = '';
            document.getElementById('triggerInput').value = '';
            document.getElementById('appendInput').value = '';
            document.getElementById('swapsInput').value = '';
            document.getElementById('implicationsInput').value = '';
            document.getElementById('blacklistInput').value = '';
            document.getElementById('maxTagsInput').value = '75';
            document.getElementById('sortSelect').value = 'danbooru';
            document.getElementById('suggestionCountInput').value = '15';
            document.getElementById('deduplicateToggle').checked = true;
            document.getElementById('underscoreToggle').checked = true;
            document.getElementById('enableWeightingToggle').checked = false;
            document.getElementById('rating-safe').checked = true;
            document.getElementById('rating-general').checked = true;
            document.getElementById('rating-questionable').checked = false;
            
            applyTheme('theme-indigo');
            toggleSettingsPanel();
            processAll();
        }
    }

    // Enhanced token management
    function showTokenSettings() {
        const panel = document.getElementById('tokenPanel');
        const input = document.getElementById('githubTokenInput');
        const checkbox = document.getElementById('rememberToken');
        
        // Load saved token if exists
        const savedToken = localStorage.getItem('github-pat');
        if (savedToken) {
            input.value = savedToken;
            checkbox.checked = true;
            gitHubPat = savedToken;
        }
        
        updateTokenStatus();
        panel.classList.remove('hidden');
    }
    
    function hideTokenSettings() {
        document.getElementById('tokenPanel').classList.add('hidden');
    }
    
    function saveToken() {
        const token = document.getElementById('githubTokenInput').value.trim();
        const remember = document.getElementById('rememberToken').checked;
        
        if (!token) {
            alert('Please enter a valid GitHub token');
            return;
        }
        
        gitHubPat = token;
        
        if (remember) {
            localStorage.setItem('github-pat', token);
        } else {
            localStorage.removeItem('github-pat');
        }
        
        updateTokenStatus();
        document.getElementById('copyMessage').textContent = 'Token saved successfully!';
        setTimeout(() => document.getElementById('copyMessage').textContent = '', 3000);
    }
    
    function testToken() {
        const token = document.getElementById('githubTokenInput').value.trim();
        if (!token) {
            alert('Please enter a token first');
            return;
        }
        
        // Test the token by making a simple API call
        fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/vnd.github+json'
            }
        })
        .then(response => {
            const statusEl = document.getElementById('tokenStatus');
            if (response.ok) {
                statusEl.innerHTML = '<span class="text-green-400">✓ Token is valid and has access</span>';
            } else if (response.status === 401) {
                statusEl.innerHTML = '<span class="text-red-400">✗ Invalid token</span>';
            } else if (response.status === 403) {
                statusEl.innerHTML = '<span class="text-yellow-400">⚠ Token valid but insufficient permissions</span>';
            } else {
                statusEl.innerHTML = '<span class="text-red-400">✗ Connection failed</span>';
            }
        })
        .catch(error => {
            document.getElementById('tokenStatus').innerHTML = '<span class="text-red-400">✗ Connection error</span>';
        });
    }
    
    function updateTokenStatus() {
        const statusEl = document.getElementById('tokenStatus');
        if (gitHubPat || localStorage.getItem('github-pat')) {
            statusEl.innerHTML = '<span class="text-green-400">✓ Token configured</span>';
        } else {
            statusEl.innerHTML = '<span class="text-gray-400">No token configured</span>';
        }
    }

    // Enhanced tag categorization with better heuristics
    class EnhancedTagCategorizer extends TagCategorizer {
        constructor(tagMap, allTags, categoryOrder) {
            super(tagMap, allTags, categoryOrder);
            this.buildEnhancedHeuristics();
        }

        buildEnhancedHeuristics() {
            // Character-specific patterns
            this.characterPatterns = [
                /\([^)]+\)$/, // Series tags like (genshin_impact)
                /_\([^)]+\)$/, // Character tags like yae_miko_(genshin_impact)
                /^[a-z]+_[a-z]+_\([^)]+\)$/, // Full character names
            ];

            // Quality indicators
            this.qualityKeywords = new Set([
                'quality', 'masterpiece', 'best', 'high', 'ultra', 'super', 'extremely',
                'detailed', 'resolution', 'res', '4k', '8k', 'hd', 'uhd', 'absurdres'
            ]);

            // Composition keywords
            this.compositionKeywords = new Set([
                'shot', 'view', 'angle', 'perspective', 'focus', 'body', 'portrait',
                'landscape', 'close-up', 'wide', 'cowboy', 'full', 'upper', 'lower'
            ]);

            // Body part keywords
            this.bodyPartKeywords = new Set([
                'breasts', 'ass', 'butt', 'thighs', 'legs', 'arms', 'hands', 'feet',
                'face', 'eyes', 'hair', 'skin', 'body', 'torso', 'chest', 'belly',
                'navel', 'shoulders', 'back', 'neck', 'head', 'nose', 'lips', 'mouth'
            ]);

            // Clothing keywords
            this.clothingKeywords = new Set([
                'dress', 'shirt', 'pants', 'skirt', 'shorts', 'jacket', 'coat',
                'bikini', 'swimsuit', 'underwear', 'bra', 'panties', 'socks',
                'stockings', 'thighhighs', 'pantyhose', 'boots', 'shoes', 'gloves'
            ]);

            // Action keywords
            this.actionKeywords = new Set([
                'sitting', 'standing', 'lying', 'walking', 'running', 'jumping',
                'dancing', 'singing', 'eating', 'drinking', 'sleeping', 'smiling',
                'looking', 'holding', 'grabbing', 'touching', 'reaching'
            ]);

            // Setting keywords
            this.settingKeywords = new Set([
                'background', 'outdoor', 'indoor', 'room', 'bedroom', 'bathroom',
                'kitchen', 'school', 'office', 'beach', 'forest', 'city', 'sky',
                'night', 'day', 'sunset', 'sunrise', 'moon', 'star', 'cloud'
            ]);
        }

        categorizeEnhanced(tagString) {
            const tag = tagString.toLowerCase().replace(/ /g, '_');
            
            // First check primary index
            if (this.primaryIndex[tag]) {
                return { category: this.primaryIndex[tag], source: 'Primary', confidence: 1.0 };
            }

            // Character detection with high confidence
            for (const pattern of this.characterPatterns) {
                if (pattern.test(tag)) {
                    return { category: 'Characters', source: 'Pattern (Character)', confidence: 0.95 };
                }
            }

            // Keyword-based categorization with confidence scoring
            const words = tag.split('_');
            const scores = {};

            // Check each word against keyword sets
            words.forEach(word => {
                if (this.qualityKeywords.has(word)) {
                    scores['Quality'] = (scores['Quality'] || 0) + 0.8;
                }
                if (this.compositionKeywords.has(word)) {
                    scores['Composition'] = (scores['Composition'] || 0) + 0.7;
                }
                if (this.bodyPartKeywords.has(word)) {
                    scores['Body Parts'] = (scores['Body Parts'] || 0) + 0.9;
                }
                if (this.clothingKeywords.has(word)) {
                    scores['Attire'] = (scores['Attire'] || 0) + 0.8;
                }
                if (this.actionKeywords.has(word)) {
                    scores['Actions & Poses'] = (scores['Actions & Poses'] || 0) + 0.7;
                }
                if (this.settingKeywords.has(word)) {
                    scores['Setting & Environment'] = (scores['Setting & Environment'] || 0) + 0.8;
                }
            });

            // Color detection
            const colorWords = ['red', 'blue', 'green', 'yellow', 'purple', 'pink', 'orange', 'black', 'white', 'grey', 'gray', 'brown'];
            if (words.some(word => colorWords.includes(word))) {
                if (words.some(word => ['hair', 'eyes'].includes(word))) {
                    scores['Hair'] = (scores['Hair'] || 0) + 0.6;
                    scores['Eyes'] = (scores['Eyes'] || 0) + 0.6;
                } else if (words.some(word => this.clothingKeywords.has(word))) {
                    scores['Attire'] = (scores['Attire'] || 0) + 0.5;
                }
            }

            // Find best match
            if (Object.keys(scores).length > 0) {
                const bestCategory = Object.entries(scores).reduce((a, b) => a[1] > b[1] ? a : b);
                return { 
                    category: bestCategory[0], 
                    source: 'Enhanced Heuristic', 
                    confidence: Math.min(bestCategory[1], 0.9) 
                };
            }

            // Fallback to original heuristics
            const original = super.categorize(tagString);
            return { ...original, confidence: 0.3 };
        }

        // Override the original categorize method
        categorize(tagString) {
            return this.categorizeEnhanced(tagString);
        }
    }

    // Auto-load token on startup
    function initializeToken() {
        const savedToken = localStorage.getItem('github-pat');
        if (savedToken) {
            gitHubPat = savedToken;
            console.log('GitHub token loaded from storage');
        }
    }

    // Enhanced theme application with smooth transitions
    function applyTheme(theme) {
        document.documentElement.className = 'dark';
        document.body.className = `p-4 md:p-6 lg:p-8 ${theme}`;
        
        document.querySelectorAll('.theme-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.theme === theme);
        });
        
        localStorage.setItem('danbooru-tag-helper-theme', theme);
        
        // Smooth color transition
        document.documentElement.style.setProperty('--transition', 'all 0.3s ease-in-out');
        setTimeout(() => {
            document.documentElement.style.removeProperty('--transition');
        }, 300);
    }

    // Enhanced statistics updates
    function updateStats() {
        const tagCount = baseTags.length;
        const maxTags = parseInt(document.getElementById('maxTagsInput').value) || 75;
        const categoryCount = new Set(baseTags.map(t => t.category)).size;
        const historyCount = copyHistory.length;
        
        document.getElementById('tagCount').textContent = tagCount;
        document.getElementById('maxTagCount').textContent = maxTags;
        document.getElementById('categoryCount').textContent = categoryCount;
        document.getElementById('historyCount').textContent = historyCount;
        
        // Update processed tag count
        document.getElementById('processedTagCount').textContent = tagCount;
        document.getElementById('processedMaxTagCount').textContent = maxTags;
        
        // Add warning colors if approaching limits
        const tagCountEl = document.getElementById('tagCount');
        const percentage = (tagCount / maxTags) * 100;
        if (percentage > 90) {
            tagCountEl.style.color = '#ef4444'; // red
        } else if (percentage > 75) {
            tagCountEl.style.color = '#f59e0b'; // amber
        } else {
            tagCountEl.style.color = 'var(--accent-color)';
        }
    }

    // Placeholder for your existing JavaScript
    // All your existing functions (processAll, displayTags, etc.) would go here
    // I'm including the essential structure that would need to be integrated

    let TAG_DATABASE = [], gitHubPat = null, tagCategorizer, tagIdCounter = 0;
    let baseTags = [], copyHistory = [], selectedTagIds = new Set(), sortableInstances = [];
    let autocomplete = { active: false, index: -1, currentWord: '', suggestions: [] };

    // Mock functions for demonstration - replace with your actual implementation
    function processAll() {
        // Your existing processAll function
        updateStats();
    }

    function displayTags() {
        // Your existing displayTags function
        updateStats();
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize token management
        initializeToken();
        
        // Apply saved theme
        const savedTheme = localStorage.getItem('danbooru-tag-helper-theme') || 'theme-indigo';
        applyTheme(savedTheme);
        
        // Load saved history
        const savedHistory = localStorage.getItem('danbooru-tag-history');
        if (savedHistory) {
            copyHistory = JSON.parse(savedHistory);
        }
        
        // Setup theme buttons
        document.querySelectorAll('.theme-button').forEach(btn => {
            btn.addEventListener('click', () => applyTheme(btn.dataset.theme));
        });
        
        // Setup all event listeners
        // Your existing event listener setup would go here
        
        updateStats();
        updateTokenStatus();
    });
    </script>
</body>
</html>
