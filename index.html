<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danbooru Tag Helper — Upgraded</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      /* Base styles (kept from your original) */
      body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
      textarea { resize: vertical; }
      /* Highlight style */
      .highlight { background-color: #a16207; color: #fefce8; border-radius: 0.25rem; padding: 0 0.125rem; font-weight: 600; box-shadow: inset 0 0 0 1px #facc15; }
      /* Animation */
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
      .fade-in { animation: fadeIn 0.3s ease-out forwards; }
      /* Tag transitions */
      #tagOutput span, #triggerDisplay span, #appendDisplay span { transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease; }
      /* Icon styles */
      .icon-img { width: 1.25rem; height: 1.25rem; display: inline-block; vertical-align: middle; filter: invert(1); }
      .search-icon-img { width: 1.125rem; height: 1.125rem; filter: invert(70%) sepia(10%) saturate(200%) hue-rotate(180deg) brightness(90%) contrast(85%); }
      .copy-icon-img { width: 1rem; height: 1rem; margin-right: 0.5rem; filter: invert(1); }
      /* Count display */
      .count-display { font-size: 0.875rem; color: #9ca3af; margin-left: 0.5rem; }
      /* Input/Select base */
      .input-base { border: 1px solid #4b5563; background-color: #374151; color: #f3f4f6; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); padding: 0.5rem 0.75rem; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
      .input-base:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); }
      .input-base::placeholder { color: #6b7280; }
      /* Checkbox base (fixed: the original had tailwind class names inside CSS; this makes them real CSS) */
      .checkbox-base { height: 1rem; width: 1rem; border: 1px solid #4b5563; border-radius: 0.25rem; cursor: pointer; background-color: #374151; }
      .checkbox-base:focus { outline: 2px solid transparent; box-shadow: 0 0 0 3px rgba(79,70,229,.45); }
      /* Tag styles */
      .tag-base { font-size: 0.875rem; font-weight: 500; padding: 0.125rem 0.625rem; border-radius: 9999px; border-width: 1px; border-style: solid; }
      .processed-tag { background-color: #3730a3; color: #c7d2fe; border-color: #6366f1; } /* indigo */
      .trigger-tag { background-color: #581c87; color: #e9d5ff; border-color: #a855f7; } /* purple */
      .append-tag { background-color: #134e4a; color: #ccfbf1; border-color: #2dd4bf; } /* teal */
      /* Utility */
      .kbd { font: 600 12px/1 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; padding: 2px 6px; border-radius: 6px; background: rgba(255,255,255,.08) }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex items-center justify-center">

    <div class="bg-gray-800 p-6 md:p-8 rounded-lg shadow-xl w-full max-w-4xl relative">
      <div class="flex items-start md:items-center justify-between gap-3 flex-col md:flex-row">
        <h1 class="text-3xl font-bold text-gray-100">Danbooru Tag Helper</h1>
        <div class="flex items-center gap-2 text-xs">
          <span class="px-2 py-1 rounded-full bg-gray-700 border border-gray-600">New: Prompt Order</span>
          <span class="px-2 py-1 rounded-full bg-gray-700 border border-gray-600">Quick Move</span>
          <span class="px-2 py-1 rounded-full bg-gray-700 border border-gray-600">Export/Import</span>
          <span class="px-2 py-1 rounded-full bg-gray-700 border border-gray-600">Smart Sort</span>
        </div>
      </div>

      <!-- Inputs -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 mt-4">
        <div>
          <label for="tagInput" class="block text-sm font-medium text-gray-300 mb-2">
            Enter tags (comma-separated):
            <span id="initialTagCountDisplay" class="count-display">(Initial: 0)</span>
          </label>
          <textarea id="tagInput" rows="4" class="w-full input-base" placeholder="e.g., 1girl, solo, looking_at_viewer..."></textarea>
        </div>
        <div>
          <label for="blacklistInput" class="block text-sm font-medium text-gray-300 mb-2">Blacklist (exclude tags containing these):</label>
          <textarea id="blacklistInput" rows="4" class="w-full input-base" placeholder="e.g., bad_anatomy, blurry, text..."></textarea>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label for="triggerInput" class="block text-sm font-medium text-gray-300 mb-2">Prepend Trigger Words:</label>
          <input type="text" id="triggerInput" class="w-full input-base" placeholder="e.g., trigger_word, style_prompt...">
          <div class="mt-2 flex items-center gap-4">
            <label class="inline-flex items-center gap-2">
              <input id="uniquifyTriggerToggle" type="checkbox" class="checkbox-base">
              <span class="text-sm text-gray-300 cursor-pointer" title="Apply simple character substitutions (e->3, s->5, etc.)">Uniquify Triggers</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input id="dedupeToggle" type="checkbox" class="checkbox-base" checked>
              <span class="text-sm text-gray-300">Deduplicate Tags</span>
            </label>
          </div>
        </div>
        <div>
          <label for="appendInput" class="block text-sm font-medium text-gray-300 mb-2">Append Tags:</label>
          <input type="text" id="appendInput" class="w-full input-base" placeholder="e.g., high_quality, best_quality...">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="relative">
          <label for="searchInput" class="block text-sm font-medium text-gray-300 mb-2">Search Tags:</label>
          <div class="absolute inset-y-0 left-0 pl-3 pt-8 flex items-center pointer-events-none">
            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/search.svg" alt="Search" class="search-icon-img" />
          </div>
          <input type="text" id="searchInput" class="w-full pl-10 input-base" placeholder="Search tags...">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label for="searchTargetSelect" class="block text-sm font-medium text-gray-300 mb-2">Search In:</label>
            <select id="searchTargetSelect" class="input-base text-sm w-full">
              <option value="processed" selected>Processed Tags (Highlight Matches)</option>
              <option value="original">Original Input (Show Match Count Only)</option>
            </select>
          </div>
          <div>
            <label for="sortSelect" class="block text-sm font-medium text-gray-300 mb-2">Sort Order:</label>
            <select id="sortSelect" class="input-base text-sm w-full">
              <option value="none">None</option>
              <option value="az">A → Z</option>
              <option value="za">Z → A</option>
              <option value="smart">Smart (by length)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Prompt Order + Quick Move + Export/Import -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="bg-gray-700 border border-gray-600 rounded-md p-3">
          <h3 class="text-sm font-medium text-gray-300 mb-2">Prompt Order</h3>
          <select id="orderSelect" class="input-base text-sm w-full">
            <option value="trigger,processed,append">Triggers → Processed → Appends</option>
            <option value="processed,trigger,append">Processed → Triggers → Appends</option>
            <option value="trigger,append,processed">Triggers → Appends → Processed</option>
            <option value="processed,append,trigger">Processed → Appends → Triggers</option>
          </select>
          <p class="text-xs text-gray-400 mt-2">This only affects the combined output and copy action.</p>
        </div>
        <div class="bg-gray-700 border border-gray-600 rounded-md p-3">
          <h3 class="text-sm font-medium text-gray-300 mb-2">Quick Move Selected Tag</h3>
          <div class="flex items-center gap-2">
            <select id="moveToSelect" class="input-base text-sm">
              <option value="triggerInput">→ Triggers</option>
              <option value="tagInput" selected>→ Main</option>
              <option value="appendInput">→ Appends</option>
            </select>
            <button id="moveTagBtn" class="px-3 py-2 text-sm rounded-md bg-gray-600 hover:bg-gray-500 border border-gray-500">Move</button>
          </div>
          <p class="text-xs text-gray-400 mt-2">Place the caret on a tag in any field. Click <b>Move</b> to send it.</p>
        </div>
      </div>

      <!-- Export / Import -->
      <div class="bg-gray-700 border border-gray-600 rounded-md p-3 mb-6">
        <h3 class="text-sm font-medium text-gray-300 mb-2">Export / Import Settings</h3>
        <div class="flex items-center gap-3">
          <button id="exportBtn" class="px-3 py-2 text-sm rounded-md bg-gray-600 hover:bg-gray-500 border border-gray-500">Export JSON</button>
          <input id="importFile" type="file" accept="application/json" class="text-sm" />
          <button id="clearBtn" class="px-3 py-2 text-sm rounded-md bg-gray-600 hover:bg-gray-500 border border-gray-500">Clear All</button>
        </div>
        <p class="text-xs text-gray-400 mt-2">Includes text fields, toggles, sort/order, and limits.</p>
      </div>

      <!-- Displays -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <h3 class="text-sm font-medium text-gray-400 mb-1">Trigger Words (Prepended):</h3>
          <div id="triggerDisplay" class="p-2 bg-gray-700 border border-gray-600 rounded-md min-h-[38px] flex flex-wrap gap-2">
            <span class="text-gray-500 italic text-sm">None entered...</span>
          </div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-400 mb-1">Append Tags (Appended):</h3>
          <div id="appendDisplay" class="p-2 bg-gray-700 border border-gray-600 rounded-md min-h-[38px] flex flex-wrap gap-2">
            <span class="text-gray-500 italic text-sm">None entered...</span>
          </div>
        </div>
      </div>

      <div>
        <div class="flex flex-wrap items-center justify-start gap-4 mb-3">
          <label class="inline-flex items-center">
            <input id="underscoreToggle" type="checkbox" class="checkbox-base mr-2" checked>
            <span class="text-sm text-gray-300">Use Underscores</span>
          </label>
          <div class="flex items-center">
            <input type="number" id="maxTagsInput" value="15" min="1" max="500" class="input-base text-sm w-24" aria-label="Maximum Tags">
            <span class="text-sm text-gray-400 ml-2">Max Tags</span>
          </div>
        </div>

        <h2 id="processedTagsLabel" class="text-lg font-semibold text-gray-200 mb-3">
          Processed Tags (<span id="tagCount">0</span>/15):
          <span id="searchMatchCountDisplay" class="count-display" style="display: none;">(0 matches)</span>
        </h2>
        <p id="limitMessage" class="text-sm text-red-400 mb-3" style="display: none;">Tag limit reached.</p>
        <div id="tagOutput" class="p-4 bg-gray-700 border border-gray-600 rounded-md min-h-[60px] flex flex-wrap gap-2">
          <span class="text-gray-400 italic">Start typing or paste tags above...</span>
        </div>
      </div>

      <div class="mt-6 text-center">
        <button id="copyButton" class="inline-flex items-center px-6 py-2.5 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105 active:scale-95" disabled>
          <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/copy.svg" alt="Copy" class="copy-icon-img" />
          Copy All Tags
        </button>
        <p id="copyMessage" class="text-sm text-green-400 mt-2" style="display: none;">Tags copied to clipboard!</p>
        <p id="statusMessage" class="text-xs text-gray-400 mt-1"></p>
        <p class="text-xs text-gray-500 mt-2">Keyboard tip: Press <span class="kbd">Tab</span> in <b>Main Tags</b> to insert a comma — fixed from double-advance.</p>
      </div>
    </div>

    <script>
      // --- DOM Elements ---
      const tagInput = document.getElementById('tagInput');
      const blacklistInput = document.getElementById('blacklistInput');
      const triggerInput = document.getElementById('triggerInput');
      const appendInput = document.getElementById('appendInput');
      const uniquifyTriggerToggle = document.getElementById('uniquifyTriggerToggle');
      const dedupeToggle = document.getElementById('dedupeToggle');
      const underscoreToggle = document.getElementById('underscoreToggle');
      const searchInput = document.getElementById('searchInput');
      const searchTargetSelect = document.getElementById('searchTargetSelect');
      const sortSelect = document.getElementById('sortSelect');
      const orderSelect = document.getElementById('orderSelect');
      const maxTagsInput = document.getElementById('maxTagsInput');
      const triggerDisplay = document.getElementById('triggerDisplay');
      const appendDisplay = document.getElementById('appendDisplay');
      const tagOutput = document.getElementById('tagOutput');
      const processedTagsLabel = document.getElementById('processedTagsLabel');
      const limitMessage = document.getElementById('limitMessage');
      const copyButton = document.getElementById('copyButton');
      const copyMessage = document.getElementById('copyMessage');
      const statusMessage = document.getElementById('statusMessage');
      const moveToSelect = document.getElementById('moveToSelect');
      const moveTagBtn = document.getElementById('moveTagBtn');

      // --- State ---
      let originalInputTags = [];
      let baseTags = [];
      let currentBlacklist = [];
      let currentTriggers = [];
      let currentAppends = [];

      // --- Constants ---
      const UNIQUIFY_MAP = { 'a': '4', 'e': '3', 'i': '1', 'o': '0', 's': '5', 'g': '9' };

      // --- Helpers ---
      const $ = (id) => document.getElementById(id);
      function escapeHTML(str) { const p = document.createElement('p'); p.textContent = str; return p.innerHTML; }
      function uniqueCaseInsensitive(list){ const seen=new Set(); const out=[]; for(const t of list){ const k=t.toLowerCase(); if(!seen.has(k)){ seen.add(k); out.push(t);} } return out; }
      function withUnderscores(tag){ return underscoreToggle.checked ? tag.replace(/\s+/g,'_') : tag.replace(/_/g,' '); }
      function parseCommaList(str){ return str.split(',').map(s=>s.trim()).filter(Boolean); }
      function getCurrentMaxTags(){ const v=parseInt(maxTagsInput.value,10); return isNaN(v)||v<1?15:Math.min(v,500); }
      function sortList(list, mode){
        if(mode==='az') return [...list].sort((a,b)=>a.localeCompare(b));
        if(mode==='za') return [...list].sort((a,b)=>b.localeCompare(a));
        if(mode==='smart') return [...list].sort((a,b)=>b.length - a.length);
        return list;
      }

      // --- Triggers / Appends display ---
      function uniquifyWord(word){ return word.split('').map(c=>UNIQUIFY_MAP[c.toLowerCase()]||c).join(''); }
      function displayTriggers(){
        triggerDisplay.innerHTML='';
        const shouldUniq = uniquifyTriggerToggle.checked;
        const view = shouldUniq ? currentTriggers.map(uniquifyWord) : currentTriggers;
        if(view.length===0){ triggerDisplay.innerHTML='<span class="text-gray-500 italic text-sm">None entered...</span>'; return; }
        view.forEach(w=>{ const el=document.createElement('span'); el.className='tag-base trigger-tag'; el.textContent=w; triggerDisplay.appendChild(el); });
      }
      function displayAppends(){
        appendDisplay.innerHTML='';
        if(currentAppends.length===0){ appendDisplay.innerHTML='<span class="text-gray-500 italic text-sm">None entered...</span>'; return; }
        currentAppends.forEach(w=>{ const el=document.createElement('span'); el.className='tag-base append-tag'; el.textContent=w; appendDisplay.appendChild(el); });
      }

      // --- Processing pipeline ---
      function processTriggers(){ currentTriggers = parseCommaList(triggerInput.value); displayTriggers(); }
      function processAppends(){ currentAppends = parseCommaList(appendInput.value); displayAppends(); }
      function processBlacklist(){ currentBlacklist = parseCommaList(blacklistInput.value.toLowerCase()); processInput(); }
      function processInput(){
        const rawText = tagInput.value;
        originalInputTags = rawText.replace(/[\n\s]+/g,' ').split(',').map(t=>t.trim()).filter(Boolean);
        $('#initialTagCountDisplay').textContent = `(Initial: ${originalInputTags.length})`;

        let filtered = originalInputTags.filter(tag=>!currentBlacklist.some(bw=>tag.toLowerCase().includes(bw)));
        if(dedupeToggle.checked) filtered = uniqueCaseInsensitive(filtered);
        const max = getCurrentMaxTags();
        baseTags = filtered.slice(0, max);
        limitMessage.style.display = filtered.length > max ? 'block' : 'none';
        displayTags();
      }

      function displayTags(){
        const searchTerm = searchInput.value.trim().toLowerCase();
        const searchTarget = searchTargetSelect.value;
        const sortMode = sortSelect.value;
        const max = getCurrentMaxTags();
        const tagCountSpanInnerId = 'tagCount'; // reinserted each time

        // Update header
        processedTagsLabel.innerHTML = `Processed Tags (<span id="${tagCountSpanInnerId}">${baseTags.length}</span>/${max}): <span id="searchMatchCountDisplay" class="count-display" style="display:none;">(0 matches)</span>`;
        const searchMatchCountDisplay = $('#searchMatchCountDisplay');
        const highlight = (searchTarget==='processed');

        // Prepare formatted list
        let final = baseTags.map(withUnderscores);
        final = sortList(final, sortMode);

        tagOutput.innerHTML='';
        let matchCount = 0;

        if(final.length===0 && highlight){
          tagOutput.innerHTML = '<span class="text-gray-400 italic">Start typing or paste tags above...</span>';
          copyButton.disabled = (currentTriggers.length===0 && currentAppends.length===0);
          searchMatchCountDisplay.style.display = (searchTarget==='original' && searchTerm)?'inline':'none';
          if(searchTarget==='original' && searchTerm){
            matchCount = originalInputTags.filter(t=>t.toLowerCase().includes(searchTerm)).length;
            searchMatchCountDisplay.textContent = `(${matchCount} matches in original)`;
          }
          return;
        }

        final.forEach(tag=>{
          const span = document.createElement('span');
          span.className='tag-base processed-tag';
          const lower = tag.toLowerCase();
          if(highlight && searchTerm && lower.includes(searchTerm)){
            matchCount++;
            const sIdx = lower.indexOf(searchTerm);
            const eIdx = sIdx + searchTerm.length;
            span.innerHTML = escapeHTML(tag.slice(0,sIdx)) + '<span class="highlight">' + escapeHTML(tag.slice(sIdx,eIdx)) + '</span>' + escapeHTML(tag.slice(eIdx));
          }else{
            span.textContent = tag;
          }
          tagOutput.appendChild(span);
        });

        if(!highlight && searchTerm){
          matchCount = originalInputTags.filter(t=>t.toLowerCase().includes(searchTerm)).length;
        }
        if(searchTerm){
          searchMatchCountDisplay.textContent = `(${matchCount}${highlight?' matches':' matches in original'})`;
          searchMatchCountDisplay.style.display = 'inline';
        }else{
          searchMatchCountDisplay.style.display = 'none';
        }

        copyButton.disabled = (currentTriggers.length===0 && currentAppends.length===0 && final.length===0);
      }

      // --- Copy / Compose based on Prompt Order ---
      function composeAll(){
        const shouldUniq = uniquifyTriggerToggle.checked;
        const trig = shouldUniq ? currentTriggers.map(uniquifyWord) : currentTriggers;
        let processed = sortList(baseTags.map(withUnderscores), sortSelect.value);
        const app = currentAppends;
        const order = orderSelect.value.split(','); // e.g., "trigger,processed,append"
        const parts = { trigger: trig, processed, append: app };
        let combined = [];
        for(const key of order){ combined.push(...(parts[key]||[])); }
        return combined.join(', ');
      }

      function copyTagsToClipboard(){
        if (!navigator.clipboard || !navigator.clipboard.writeText) {
          copyMessage.textContent = 'Copy failed: insecure context.';
          copyMessage.className = 'text-sm text-red-400 mt-2';
          copyMessage.style.display = 'block';
          setTimeout(()=>{ copyMessage.style.display='none'; }, 2500);
          return;
        }
        const text = composeAll();
        navigator.clipboard.writeText(text).then(()=>{
          copyMessage.textContent = 'Tags copied to clipboard!';
          copyMessage.className = 'text-sm text-green-400 mt-2 fade-in';
          copyMessage.style.display = 'block';
          setTimeout(()=> copyMessage.classList.remove('fade-in'), 300);
          setTimeout(()=>{ copyMessage.style.display='none'; }, 1600);
        }).catch(err=>{
          console.error(err);
          copyMessage.textContent = 'Copy failed! (See console)';
          copyMessage.className = 'text-sm text-red-400 mt-2';
          copyMessage.style.display = 'block';
          setTimeout(()=>{ copyMessage.style.display='none'; }, 2500);
        });
      }

      // --- Quick Move selected tag between fields ---
      function wordUnderCaret(inputEl){
        const v = inputEl.value;
        let s = inputEl.selectionStart;
        let e = inputEl.selectionEnd;
        if(s!==e){ return v.slice(s,e).trim().replace(/^,|,$/g,''); }
        while(s>0 && v[s-1]!==',' && v[s-1]!=='\n') s--;
        while(e<v.length && v[e]!==',' && v[e]!== '\n') e++;
        return v.slice(s,e).trim().replace(/^,|,$/g,'');
      }
      function removeWord(inputEl, word){
        const re = new RegExp('(^|,|\n)\s*'+word.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'\s*(?=,|\n|$)','i');
        inputEl.value = inputEl.value.replace(re,(m,p1)=> p1 && p1.trim()? p1+', ':'').replace(/\s+,/g,',').replace(/,\s*,/g,', ').trim();
      }
      function appendWord(inputEl, word){
        const val = inputEl.value.trim();
        inputEl.value = val ? (val.replace(/,?\s*$/,'') + ', ' + word) : word;
      }

      // --- Storage / Export-Import ---
      const STORAGE_KEY = 'dbh:state:v2';
      function saveState(){
        const data = {
          tags: tagInput.value, bl: blacklistInput.value, trig: triggerInput.value, app: appendInput.value,
          uniq: uniquifyTriggerToggle.checked, dedupe: dedupeToggle.checked, under: underscoreToggle.checked,
          sort: sortSelect.value, order: orderSelect.value, max: maxTagsInput.value
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        statusMessage.textContent = 'Saved to local storage.';
        setTimeout(()=> statusMessage.textContent = '', 900);
      }
      function restoreState(){
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        try{
          const d = JSON.parse(raw);
          tagInput.value = d.tags||''; blacklistInput.value = d.bl||''; triggerInput.value = d.trig||''; appendInput.value = d.app||'';
          uniquifyTriggerToggle.checked = !!d.uniq; dedupeToggle.checked = d.dedupe!==false; underscoreToggle.checked = !!d.under;
          sortSelect.value = d.sort||'none'; orderSelect.value = d.order||'trigger,processed,append'; maxTagsInput.value = d.max||15;
        }catch(e){}
      }
      function doExport(){
        const blob = new Blob([ localStorage.getItem(STORAGE_KEY) || '{}' ], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'danbooru-helper-settings.json'; a.click();
        URL.revokeObjectURL(url);
      }
      function doImport(e){
        const file = e.target.files && e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{ try{ localStorage.setItem(STORAGE_KEY, reader.result); restoreState(); processTriggers(); processAppends(); processBlacklist(); processInput(); displayTags(); statusMessage.textContent='Imported ✓'; setTimeout(()=>statusMessage.textContent='', 900);}catch{ statusMessage.textContent='Import failed'; setTimeout(()=>statusMessage.textContent='', 1200);} };
        reader.readAsText(file);
      }
      function clearAll(){
        tagInput.value=''; blacklistInput.value=''; triggerInput.value=''; appendInput.value='';
        searchInput.value=''; maxTagsInput.value=15; sortSelect.value='none'; orderSelect.value='trigger,processed,append';
        dedupeToggle.checked=true; underscoreToggle.checked=true; uniquifyTriggerToggle.checked=false;
        processTriggers(); processAppends(); processBlacklist(); processInput(); displayTags(); saveState();
      }

      // --- Event Listeners ---
      tagInput.addEventListener('input', ()=>{ processInput(); saveState(); });
      blacklistInput.addEventListener('input', ()=>{ processBlacklist(); saveState(); });
      triggerInput.addEventListener('input', ()=>{ processTriggers(); saveState(); });
      appendInput.addEventListener('input', ()=>{ processAppends(); saveState(); });
      uniquifyTriggerToggle.addEventListener('change', ()=>{ displayTriggers(); saveState(); });
      dedupeToggle.addEventListener('change', ()=>{ processInput(); saveState(); });
      underscoreToggle.addEventListener('change', ()=>{ displayTags(); saveState(); });
      searchInput.addEventListener('input', displayTags);
      searchTargetSelect.addEventListener('change', displayTags);
      sortSelect.addEventListener('change', ()=>{ displayTags(); saveState(); });
      orderSelect.addEventListener('change', ()=>{ saveState(); });
      maxTagsInput.addEventListener('input', ()=>{ processInput(); saveState(); });
      copyButton.addEventListener('click', copyTagsToClipboard);

      // Fix: Tab key double-advance on desktop — intercept once and insert ", "
      tagInput.addEventListener('keydown', (e)=>{
        if(e.key==='Tab'){
          e.preventDefault(); e.stopPropagation();
          const val = tagInput.value;
          const s = tagInput.selectionStart;
          const needsComma = val.slice(0,s).trim().length>0 && !val.slice(0,s).trim().endsWith(',');
          const insert = needsComma? ', ' : ' ';
          tagInput.setRangeText(insert, s, tagInput.selectionEnd, 'end');
          processInput();
        }
      }, true);

      // Quick Move
      moveTagBtn.addEventListener('click', ()=>{
        const active = document.activeElement;
        if(!(active && (active===tagInput || active===triggerInput || active===appendInput))){
          statusMessage.textContent = 'Focus a field first.'; setTimeout(()=>statusMessage.textContent='', 1200); return;
        }
        const word = wordUnderCaret(active);
        if(!word){ statusMessage.textContent = 'Place the caret on a tag.'; setTimeout(()=>statusMessage.textContent='', 1200); return; }
        removeWord(active, word);
        appendWord($(moveToSelect.value), word);
        processTriggers(); processAppends(); processInput(); displayTags(); saveState();
        statusMessage.textContent = `Moved “${word}”.`; setTimeout(()=>statusMessage.textContent='', 900);
      });

      // Export / Import / Clear
      document.getElementById('exportBtn').addEventListener('click', doExport);
      document.getElementById('importFile').addEventListener('change', doImport);
      document.getElementById('clearBtn').addEventListener('click', clearAll);

      // Init
      restoreState();
      processTriggers(); processAppends(); processBlacklist(); processInput();
    </script>

</body>
</html>
