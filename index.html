<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tag Composer — Enhanced</title>
  <style>
    :root{
      --bg: #0b0f17;
      --panel: rgba(255,255,255,0.06);
      --panel-2: rgba(255,255,255,0.08);
      --text: #e6ebf3;
      --muted: #9fb0c7;
      --accent: #7c9aff;
      --accent-2: #99b3ff;
      --ok: #29d76f;
      --warn: #ffcc66;
      --err: #ff6b6b;
      --ring: rgba(124,154,255,.45);
      --chip-bg: rgba(255,255,255,.08);
      --chip: #dfe7ff;
    }
    html.dark{background:var(--bg); color:var(--text);}
    *{box-sizing:border-box}
    body{margin:0; font: 500 15px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent)}
    .container{max-width:1100px; margin:0 auto; padding:24px}
    .grid{display:grid; gap:16px}
    .cols-2{grid-template-columns: repeat(2, minmax(0,1fr))}
    @media (max-width: 920px){ .cols-2{grid-template-columns: 1fr} }
    .card{background:var(--panel); border:1px solid var(--panel-2); border-radius:18px; padding:16px; backdrop-filter: blur(6px);}
    .card h3{margin:0 0 8px; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.06em}
    label{display:block; margin:6px 0 8px; color:var(--muted); font-size:13px}
    textarea, input[type="text"], input[type="number"], select{
      width:100%; background:rgba(255,255,255,.04); color:var(--text);
      border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px 12px;
      outline:none; transition: box-shadow .2s,border-color .2s;
    }
    textarea:focus, input:focus, select:focus{ box-shadow:0 0 0 4px var(--ring); border-color: var(--accent)}
    textarea{min-height:120px; resize:vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,.14); border-radius:12px; padding:10px 14px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color:var(--text); cursor:pointer; font-weight:700;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.primary{ background: linear-gradient(180deg, var(--accent), var(--accent-2)); color:#0a0a0a; border:none }
    .btn.ghost{ background: transparent }
    .toolbar{position:sticky; top:0; z-index:30; backdrop-filter: blur(8px); padding:10px 0; margin:-10px 0 14px}
    .toolbar .bar{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:8px 12px; background:var(--panel); border:1px solid var(--panel-2); border-radius:14px}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{background:var(--chip-bg); color:var(--chip); padding:6px 10px; border-radius:999px; font-size:12px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .output{min-height:160px; white-space:pre-wrap; border-radius:14px; padding:14px; background:rgba(255,255,255,.03); border:1px dashed rgba(255,255,255,.2)}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    @media (max-width: 700px){ .two{grid-template-columns:1fr} }
    .hr{height:1px; background:rgba(255,255,255,.12); margin:12px 0}
    .kbd{font: 600 12px/1 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; padding:4px 6px; border-radius:6px; background:rgba(255,255,255,.08)}
    .accent-swatch{width:28px; height:28px; border-radius:8px; border:1px solid rgba(255,255,255,.2)}
  </style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <div class="bar">
        <div class="chips">
          <span class="chip">New: Prompt order</span>
          <span class="chip">Quick Tag Move</span>
          <span class="chip">Keyboard fix</span>
          <span class="chip">Export / Import</span>
        </div>
        <div class="row">
          <button id="copyButton" class="btn primary">Copy All Tags</button>
          <span id="copyMessage" class="small muted"></span>
        </div>
      </div>
    </div>

    <div class="grid cols-2">
      <div class="card">
        <h3>Prompt Building</h3>
        <label>Prepend</label>
        <textarea id="prependInput" placeholder="e.g., masterpiece, best quality"></textarea>

        <label>Main Tags</label>
        <textarea id="tagInput" placeholder="1girl, solo, black background"></textarea>

        <label>Append</label>
        <textarea id="appendInput" placeholder="e.g., dramatic lighting"></textarea>

        <label>Negative</label>
        <textarea id="negativeInput" placeholder="lowres, bad hands, blurry"></textarea>
      </div>

      <div class="card">
        <h3>Options & Utilities</h3>
        <div class="two">
          <div>
            <label>Sorting</label>
            <select id="sortSelect">
              <option value="none">None</option>
              <option value="az">A → Z</option>
              <option value="za">Z → A</option>
              <option value="smart">Smart (len)</option>
            </select>
          </div>
          <div>
            <label>Max Tags</label>
            <input id="maxTagsInput" type="number" min="1" max="500" value="75"/>
          </div>
        </div>

        <div class="hr"></div>

        <div class="two">
          <label><input id="deduplicateToggle" type="checkbox" checked/> Deduplicate</label>
          <label><input id="underscoreToggle" type="checkbox"/> Replace spaces with underscore</label>
        </div>

        <div class="hr"></div>

        <div class="two">
          <div>
            <label>Prompt Order</label>
            <select id="orderSelect">
              <option value="pre-main-app-neg">Prepend → Main → Append → Negative</option>
              <option value="main-pre-app-neg">Main → Prepend → Append → Negative</option>
              <option value="pre-main-neg-app">Prepend → Main → Negative → Append</option>
              <option value="main-app-pre-neg">Main → Append → Prepend → Negative</option>
            </select>
          </div>
          <div>
            <label>Accent Color</label>
            <div class="row">
              <input id="accentPicker" type="color" value="#7c9aff" />
              <div id="accentSwatch" class="accent-swatch"></div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="two">
          <div>
            <label>Quick Move Selected Tag</label>
            <div class="row">
              <select id="moveToSelect">
                <option value="prependInput">→ Prepend</option>
                <option value="tagInput" selected>→ Main</option>
                <option value="appendInput">→ Append</option>
                <option value="negativeInput">→ Negative</option>
              </select>
              <button id="moveTagBtn" class="btn">Move</button>
            </div>
            <div class="small muted" style="margin-top:6px">
              Tip: place the caret on a tag; click <b>Move</b> to send it to another box.
            </div>
          </div>
          <div>
            <label>Export / Import Settings</label>
            <div class="row">
              <button id="exportBtn" class="btn ghost">Export</button>
              <input id="importFile" type="file" accept="application/json" />
            </div>
            <div class="small muted" style="margin-top:6px">Saves prompt order, toggles, and text box contents.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>Output</h3>
      <div id="tagOutput" class="output">Start typing above, then press <span class="kbd">Ctrl</span>+<span class="kbd">C</span> or click <b>Copy All Tags</b>.</div>
      <div class="row" style="margin-top:10px">
        <span class="muted small">Counts: <span id="processedTagCount">0</span>/<span id="processedMaxTagCount">75</span></span>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>Known Bug Fixes</h3>
      <ul class="small">
        <li><b>Tab key double-advance</b> on desktop when editing <i>Main Tags</i> is fixed. We intercept <span class="kbd">Tab</span> and handle it once.</li>
        <li>Safer copy routine with robust trimming/deduping.</li>
      </ul>
    </div>
  </div>

<script>
// ---------- Utilities ----------
const $ = (id) => document.getElementById(id);

function splitTags(raw){
  if(!raw) return [];
  // split by commas or newlines; trim; drop empties
  return raw.split(/[,\\n]/).map(t=>t.trim()).filter(Boolean);
}
function joinTags(list){ return list.join(', '); }
function unique(list){
  const seen = new Set(); const out = [];
  for(const t of list){
    const key = t.toLowerCase();
    if(!seen.has(key)){ seen.add(key); out.push(t); }
  }
  return out;
}
function normalizeSpaces(list){
  if(!$('#underscoreToggle').checked) return list;
  return list.map(t => t.replace(/\\s+/g, '_'));
}
function sortTags(list, mode){
  if(mode === 'az') return [...list].sort((a,b)=>a.localeCompare(b));
  if(mode === 'za') return [...list].sort((a,b)=>b.localeCompare(a));
  if(mode === 'smart') return [...list].sort((a,b)=>b.length - a.length);
  return list;
}
function clampMax(list, max){ return list.slice(0, Math.max(1, max|0)); }

function composePrompt(){
  // order
  const order = ($('#orderSelect').value || 'pre-main-app-neg').split('-');
  const parts = {
    pre: splitTags($('#prependInput').value),
    main: splitTags($('#tagInput').value),
    app: splitTags($('#appendInput').value),
    neg: splitTags($('#negativeInput').value),
  };

  let list = [];
  for(const key of order){
    if(key.startsWith('pre')) list.push(...parts.pre);
    else if(key.startsWith('main')) list.push(...parts.main);
    else if(key.startsWith('app')) list.push(...parts.app);
    else if(key.startsWith('neg')) list.push(...parts.neg);
  }

  if($('#deduplicateToggle').checked) list = unique(list);
  list = normalizeSpaces(list);
  list = sortTags(list, $('#sortSelect').value);
  const max = parseInt($('#maxTagsInput').value || '75', 10);
  list = clampMax(list, max);

  $('#processedTagCount').textContent = list.length;
  $('#processedMaxTagCount').textContent = max;
  const out = joinTags(list);
  $('#tagOutput').textContent = out || '…';
  return out;
}

function copyToClipboard(text){
  if(!navigator.clipboard){ // fallback
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    return;
  }
  return navigator.clipboard.writeText(text);
}

function setAccent(hex){
  document.documentElement.style.setProperty('--accent', hex);
  const lighter = hex;
  document.documentElement.style.setProperty('--accent-2', lighter);
  $('#accentSwatch').style.background = hex;
}

// ---------- Event Wiring ----------
function init(){
  // live compose
  for(const id of ['prependInput','tagInput','appendInput','negativeInput','sortSelect','maxTagsInput','deduplicateToggle','underscoreToggle','orderSelect']){
    const el = $(id); if(!el) continue;
    el.addEventListener('input', () => { saveState(); composePrompt(); });
    el.addEventListener('change', () => { saveState(); composePrompt(); });
  }

  // Copy button
  $('#copyButton').addEventListener('click', async () => {
    const text = composePrompt();
    await copyToClipboard(text);
    $('#copyMessage').textContent = 'Copied ✓';
    setTimeout(()=>$('#copyMessage').textContent='', 1200);
  });

  // Tab bug fix on Main Tags: prevent double-advance
  $('#tagInput').addEventListener('keydown', (e) => {
    if(e.key === 'Tab'){
      e.preventDefault(); e.stopPropagation();
      // Behavior: treat Tab as "confirm current tag" -> insert a comma+space if needed
      const ta = e.currentTarget;
      const val = ta.value;
      const pos = ta.selectionStart;
      const before = val.slice(0,pos);
      const after = val.slice(ta.selectionEnd);
      const needsComma = before.trim().length && !before.trim().endsWith(',');
      const insert = (needsComma? ', ' : ' ');
      ta.value = before + insert + after;
      const np = (before + insert).length;
      ta.setSelectionRange(np,np);
      composePrompt();
    }
  });

  // Quick Move button
  $('#moveTagBtn').addEventListener('click', () => {
    const destId = $('#moveToSelect').value;
    const active = document.activeElement;
    if(!(active instanceof HTMLTextAreaElement)) { toast('Focus a textarea first'); return; }
    const word = wordUnderCaret(active);
    if(!word){ toast('Place the caret on a tag'); return; }
    removeWordFromTextarea(active, word);
    appendToTextarea($(destId), word);
    composePrompt(); saveState();
  });

  // Accent color
  $('#accentPicker').addEventListener('input', (e)=>{ setAccent(e.target.value); saveState(); });

  // Export/Import
  $('#exportBtn').addEventListener('click', doExport);
  $('#importFile').addEventListener('change', doImport);

  // restore
  restoreState();
  composePrompt();
}

function toast(msg){
  $('#copyMessage').textContent = msg;
  setTimeout(()=>$('#copyMessage').textContent='', 1500);
}

function wordUnderCaret(ta){
  const {value, selectionStart:s, selectionEnd:e} = ta;
  // expand to nearest comma or line boundary
  let i=s, j=e;
  while(i>0 && value[i-1]!==',' && value[i-1]!== '\\n') i--;
  while(j<value.length && value[j]!==',' && value[j]!== '\\n') j++;
  const word = value.slice(i,j).trim().replace(/^,|,$/g,'');
  return word || '';
}
function removeWordFromTextarea(ta, word){
  const re = new RegExp('(^|,|\\n)\\s*'+escapeRegExp(word)+'\\s*(?=,|\\n|$)','i');
  ta.value = ta.value.replace(re, (m, p1)=> p1 && p1.trim()? p1+', ' : '' );
  ta.value = ta.value.replace(/\\s+,/g, ',').replace(/,\\s*,/g, ', ').trim();
}
function appendToTextarea(ta, word){
  const val = ta.value.trim();
  ta.value = val ? (val.replace(/,?\\s*$/,'') + ', ' + word) : word;
}
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'); }

// ---------- Persistence ----------
const STORAGE_KEY = 'tag-composer:v2';
function saveState(){
  const data = {
    pre: $('#prependInput').value,
    main: $('#tagInput').value,
    app: $('#appendInput').value,
    neg: $('#negativeInput').value,
    sort: $('#sortSelect').value,
    max: $('#maxTagsInput').value,
    dedup: $('#deduplicateToggle').checked,
    under: $('#underscoreToggle').checked,
    order: $('#orderSelect').value,
    accent: $('#accentPicker').value
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function restoreState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const d = JSON.parse(raw);
    $('#prependInput').value = d.pre || '';
    $('#tagInput').value = d.main || '';
    $('#appendInput').value = d.app || '';
    $('#negativeInput').value = d.neg || '';
    $('#sortSelect').value = d.sort || 'none';
    $('#maxTagsInput').value = d.max || 75;
    $('#deduplicateToggle').checked = !!d.dedup;
    $('#underscoreToggle').checked = !!d.under;
    $('#orderSelect').value = d.order || 'pre-main-app-neg';
    $('#accentPicker').value = d.accent || '#7c9aff'; setAccent($('#accentPicker').value);
  }catch(e){ console.error(e); }
}

function doExport(){
  const blob = new Blob([localStorage.getItem(STORAGE_KEY) || '{}'], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'tag-composer-settings.json'; a.click();
  URL.revokeObjectURL(url);
}
function doImport(e){
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      localStorage.setItem(STORAGE_KEY, reader.result);
      restoreState(); composePrompt(); toast('Imported ✓');
    }catch(err){ toast('Import failed'); }
  };
  reader.readAsText(file);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
